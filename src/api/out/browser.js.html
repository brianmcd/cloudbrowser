<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CloudBrowser Source: browser.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.readable.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">CloudBrowser</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="cloudbrowser.html">cloudbrowser</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.html">app</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="AppConfig.html">AppConfig</a>
						</li>
						
						<li>
							<a href="AppInstance.html">AppInstance</a>
						</li>
						
						<li>
							<a href="Browser.html">Browser</a>
						</li>
						
						<li>
							<a href="GoogleStrategy.html">GoogleStrategy</a>
						</li>
						
						<li>
							<a href="LocalStrategy.html">LocalStrategy</a>
						</li>
						
						<li>
							<a href="ServerConfig.html">ServerConfig</a>
						</li>
						
						<li>
							<a href="Util.html">Util</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="AppConfig.html#event:addAppInstance">addAppInstance</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:addBrowser">addBrowser</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:addUser">addUser</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:removeBrowser">removeBrowser</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:removeUser">removeUser</a>
						</li>
						
						<li>
							<a href="AppInstance.html#event:rename">rename</a>
						</li>
						
						<li>
							<a href="AppInstance.html#event:share">share</a>
						</li>
						
						<li>
							<a href="Browser.html#event:rename">rename</a>
						</li>
						
						<li>
							<a href="Browser.html#event:share">share</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: browser.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">// Generated by CoffeeScript 1.7.1
(function() {
  var Async, Browser, Components, User, areArgsValid, cloudbrowserError;

  Components = require('../server/components');

  Async = require('async');

  User = require('../server/user');

  cloudbrowserError = require('../shared/cloudbrowser_error');

  areArgsValid = require('./utils').areArgsValid;


  /**
      Event to indicate that the current browser has been shared with 
      another user
      @event Browser#share
   */


  /**
      Event to indicate that the current browser has been renamed
      @event Browser#rename
      @type {String}
   */


  /**
      API for  browsers (internal object).
      @class Browser
      @param {Object}           options 
      @param {User}             options.userCtx The current user.
      @param {Cloudbrowser}     options.cbCtx   The cloudbrowser API object.
      @param {BrowserServer}    options.browser The browser.
      @fires Browser#share
      @fires Browser#rename
   */

  Browser = (function() {
    var _pvts;

    _pvts = [];

    function Browser(options) {
      var browser, cbCtx, userCtx;
      Object.defineProperty(this, "_idx", {
        value: _pvts.length
      });
      browser = options.browser, cbCtx = options.cbCtx, userCtx = options.userCtx;
      _pvts.push({
        bserver: browser,
        userCtx: userCtx,
        cbCtx: cbCtx
      });
      Object.freeze(this.__proto__);
      Object.freeze(this);
    }


    /**
        Gets the ID of the instance.
        @method getID
        @return {Number}
        @instance
        @memberOf Browser
     */

    Browser.prototype.getID = function() {
      return _pvts[this._idx].bserver.getID();
    };


    /**
        Gets the url of the instance.
        @method getURL
        @return {String}
        @instance
        @memberOf Browser
     */

    Browser.prototype.getURL = function() {
      var bserver, domain, id, mountPoint, port, _ref;
      bserver = _pvts[this._idx].bserver;
      id = bserver.getID();
      mountPoint = bserver.getMountPoint();
      _ref = bserver.server.config, domain = _ref.domain, port = _ref.port;
      return "http://" + domain + ":" + port + mountPoint + "/browsers/" + id + "/index";
    };


    /**
        Gets the date of creation of the instance.
        @method getDateCreated
        @return {Date}
        @instance
        @memberOf Browser
     */

    Browser.prototype.getDateCreated = function() {
      return _pvts[this._idx].bserver.getDateCreated();
    };


    /**
        Gets the name of the instance.
        @method getName
        @return {String}
        @instance
        @memberOf Browser
     */

    Browser.prototype.getName = function() {
      return _pvts[this._idx].bserver.getName();
    };


    /**
        Creates a new component
        @method createComponent
        @param {String}  name    The registered name of the component.          
        @param {DOMNode} target  The DOM node in which the component will be embedded.         
        @param {Object}  options Extra options to customize the component.          
        @return {DOMNode}
        @instance
        @memberof Browser
     */

    Browser.prototype.createComponent = function(name, target, options) {
      var Ctor, browser, bserver, clientComponent, comp, rpcMethod, targetID;
      if (typeof name !== "string" || !target || !target.__nodeID) {
        return;
      }
      bserver = _pvts[this._idx].bserver;
      browser = bserver.getBrowser();
      targetID = target.__nodeID;
      if (browser.components[targetID]) {
        return cloudbrowserError("COMPONENT_EXISTS");
      }
      Ctor = Components[name];
      if (!Ctor) {
        return cloudbrowserError("NO_COMPONENT", "-" + name);
      }
      rpcMethod = function(method, args) {
        return browser.emit('ComponentMethod', {
          target: target,
          method: method,
          args: args
        });
      };
      options.cloudbrowser = {
        mountPoint: bserver.getMountPoint()
      };
      options.cbServer = bserver.server;
      comp = browser.components[targetID] = new Ctor(options, rpcMethod, target);
      clientComponent = [name, targetID, comp.getRemoteOptions()];
      browser.clientComponents.push(clientComponent);
      browser.emit('CreateComponent', clientComponent);
      return target;
    };


    /**
        Gets the Application API object.
        @method getAppConfig
        @return {AppConfig}
        @memberof Browser
        @instance
     */

    Browser.prototype.getAppConfig = function() {
      var AppConfig, app, bserver, cbCtx, mountPoint, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, cbCtx = _ref.cbCtx, userCtx = _ref.userCtx;
      mountPoint = bserver.getMountPoint();
      AppConfig = require("./application_config");
      app = bserver.server.applicationManager.find(mountPoint);
      return new AppConfig({
        cbServer: bserver.server,
        cbCtx: cbCtx,
        userCtx: userCtx,
        app: app
      });
    };


    /**
        Closes the  browser.
        @method close
        @memberof Browser
        @instance
        @param {errorCallback} callback
     */

    Browser.prototype.close = function(callback) {
      var app, appInstance, appManager, bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      appManager = bserver.server.applicationManager;
      app = appManager.find(bserver.getMountPoint());
      if (userCtx.getEmail() === "public") {
        return app.browsers.close(bserver);
      } else {
        appInstance = bserver.getAppInstance();
        if (appInstance) {
          return appInstance.removeBrowser(bserver, userCtx, callback);
        } else {
          return app.browsers.close(bserver, userCtx, callback);
        }
      }
    };


    /**
        Redirects all clients that are connected to the current
        instance to the given URL.
        @method redirect
        @param {String} url
        @memberof Browser
        @instance
     */

    Browser.prototype.redirect = function(url) {
      return _pvts[this._idx].bserver.redirect(url);
    };


    /**
        Gets the email ID that is stored in the session
        @method getResetEmail
        @param {emailCallback} callback
        @memberof Browser
        @instance
     */

    Browser.prototype.getResetEmail = function(callback) {
      var bserver, mongoInterface;
      bserver = _pvts[this._idx].bserver;
      mongoInterface = bserver.server.mongoInterface;
      return bserver.getFirstSession(function(err, session) {
        if (err) {
          return callback(err);
        }
        return callback(null, SessionManager.findPropOnSession(session, 'resetuser'));
      });
    };


    /**
        Gets the user that created the instance.
        @method getCreator
        @return {String}
        @instance
        @memberof Browser
     */

    Browser.prototype.getCreator = function() {
      var bserver, _ref;
      bserver = _pvts[this._idx].bserver;
      return (_ref = bserver.getCreator()) != null ? _ref.getEmail() : void 0;
    };


    /**
        Registers a listener for an event on the  browser instance.
        @method addEventListener
        @param {String} event
        @param {errorCallback} callback 
        @instance
        @memberof Browser
     */

    Browser.prototype.addEventListener = function(event, callback) {
      var bserver, validEvents;
      if (typeof callback !== "function") {
        return;
      }
      validEvents = ["share", "rename", "connect", "disconnect"];
      if (typeof event !== "string" || validEvents.indexOf(event) === -1) {
        return;
      }
      bserver = _pvts[this._idx].bserver;
      if (this.isAssocWithCurrentUser()) {
        switch (event) {
          case "share":
            return bserver.on(event, function(userInfo) {
              var newUserInfo;
              newUserInfo = {};
              newUserInfo.role = userInfo.role;
              newUserInfo.user = userInfo.user.getEmail();
              return callback(newUserInfo);
            });
          default:
            return bserver.on(event, callback);
        }
      }
    };


    /**
        Checks if the current user has some permission
        associated with this browser
        @method isAssocWithCurrentUser
        @return {Bool}
        @instance
        @memberof Browser
     */

    Browser.prototype.isAssocWithCurrentUser = function() {
      var appConfig, bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      appConfig = this.getAppConfig();
      if (!appConfig.isAuthConfigured() || bserver.isOwner(userCtx) || bserver.isReaderWriter(userCtx) || bserver.isReader(userCtx) || appConfig.isOwner()) {
        return true;
      } else {
        return false;
      }
    };


    /**
        Gets all users that have the permission only to read and
        write to the instance.
        @method getReaderWriters
        @return {Array&lt;User>}
        @instance
        @memberof Browser
     */

    Browser.prototype.getReaderWriters = function() {
      var bserver, rw, users, _i, _len, _ref;
      bserver = _pvts[this._idx].bserver;
      if (typeof bserver.getReaderWriters !== "function") {
        return;
      }
      if (this.isAssocWithCurrentUser()) {
        users = [];
        _ref = bserver.getReaderWriters();
        for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
          rw = _ref[_i];
          users.push(rw.getEmail());
        }
        return users;
      }
    };


    /**
        Gets all users that have the permission only to read
        @method getReaders
        @return {Array&lt;User>}
        @instance
        @memberof Browser
     */

    Browser.prototype.getReaders = function() {
      var bserver, rw, users, _i, _len, _ref;
      bserver = _pvts[this._idx].bserver;
      if (typeof bserver.getReaders !== "function") {
        return;
      }
      if (this.isAssocWithCurrentUser()) {
        users = [];
        _ref = bserver.getReaders();
        for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
          rw = _ref[_i];
          users.push(rw.getEmail());
        }
        return users;
      }
    };


    /**
        Gets all users that are the owners of the instance
        There is a separate method for this as it is faster to get only the
        number of owners than to construct a list of them using
        getOwners and then get that number.
        @method getOwners
        @return {Array&lt;User>}
        @instance
        @memberof Browser
     */

    Browser.prototype.getOwners = function() {
      var bserver, rw, users, _i, _len, _ref;
      bserver = _pvts[this._idx].bserver;
      if (typeof bserver.getOwners !== "function") {
        return;
      }
      if (this.isAssocWithCurrentUser()) {
        users = [];
        _ref = bserver.getOwners();
        for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
          rw = _ref[_i];
          users.push(rw.getEmail());
        }
        return users;
      }
    };


    /**
        Checks if the user is a reader-writer of the instance.
        @method isReaderWriter
        @param {String} user
        @return {Bool}
        @instance
        @memberof Browser
     */

    Browser.prototype.isReaderWriter = function(emailID) {
      var bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (typeof bserver.isReaderWriter !== "function") {
        return;
      }
      switch (arguments.length) {
        case 0:
          break;
        case 1:
          emailID = arguments[0];
          if (!areArgsValid([
            {
              item: emailID,
              type: "string"
            }
          ])) {
            return;
          }
          userCtx = new User(emailID);
          break;
        default:
          return;
      }
      if (this.isAssocWithCurrentUser()) {
        if (bserver.isReaderWriter(userCtx)) {
          return true;
        } else {
          return false;
        }
      }
    };


    /**
        Checks if the user is a reader of the instance.
        @method isReader
        @param {String} emailID
        @return {Bool}
        @memberof Browser
        @instance
     */

    Browser.prototype.isReader = function(emailID) {
      var bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (typeof bserver.isReader !== "function") {
        return;
      }
      switch (arguments.length) {
        case 0:
          break;
        case 1:
          emailID = arguments[0];
          if (!areArgsValid([
            {
              item: emailID,
              type: "string"
            }
          ])) {
            return;
          }
          userCtx = new User(emailID);
          break;
        default:
          return;
      }
      if (this.isAssocWithCurrentUser()) {
        if (bserver.isReader(userCtx)) {
          return true;
        } else {
          return false;
        }
      }
    };


    /**
        Checks if the user is an owner of the instance
        @method isOwner
        @param {String} user
        @return {Bool}
        @instance
        @memberof Browser
     */

    Browser.prototype.isOwner = function() {
      var bserver, emailID, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (typeof bserver.isOwner !== "function") {
        return;
      }
      switch (arguments.length) {
        case 0:
          break;
        case 1:
          emailID = arguments[0];
          if (!areArgsValid([
            {
              item: emailID,
              type: "string"
            }
          ])) {
            return;
          }
          userCtx = new User(emailID);
          break;
        default:
          return;
      }
      if (this.isAssocWithCurrentUser()) {
        if (bserver.isOwner(userCtx)) {
          return true;
        } else {
          return false;
        }
      }
    };


    /**
        Adds a user as a readerwriter of the current browser
        @method addReaderWriter
        @param {String} emailID
        @param {errorCallback} callback
        @instance
        @memberof Browser
     */

    Browser.prototype.addReaderWriter = function(emailID, callback) {
      var bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (!areArgsValid([
        {
          item: emailID,
          type: "string",
          action: callback
        }
      ])) {
        return;
      }
      if (typeof bserver.addReaderWriter !== "function") {
        return typeof callback === "function" ? callback(cloudbrowserError('API_INVALID', "- addReaderWriter")) : void 0;
      }
      return this.grantPermissions('readwrite', new User(emailID), callback);
    };


    /**
        Adds a user as an owner of the current browser
        @method addOwner
        @param {String} emailID
        @param {errorCallback} callback
        @instance
        @memberof Browser
     */

    Browser.prototype.addOwner = function(emailID, callback) {
      var bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (!areArgsValid([
        {
          item: emailID,
          type: "string",
          action: callback
        }
      ])) {
        return;
      }
      if (typeof bserver.addOwner !== "function") {
        return typeof callback === "function" ? callback(cloudbrowserError('API_INVALID', "- addOwner")) : void 0;
      }
      return this.grantPermissions('own', new User(emailID), callback);
    };


    /**
        Adds a user as a reader of the current browser
        @method addReader
        @param {String} emailID
        @param {errorCallback} callback
        @instance
        @memberof Browser
     */

    Browser.prototype.addReader = function(emailID, callback) {
      var bserver, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (!areArgsValid([
        {
          item: emailID,
          type: "string",
          action: callback
        }
      ])) {
        return;
      }
      if (typeof bserver.addReader !== "function") {
        return typeof callback === "function" ? callback(cloudbrowserError('API_INVALID', "- addReader")) : void 0;
      }
      return this.grantPermissions('readonly', new User(emailID), callback);
    };


    /**
        Grants the user a role/permission on the browser.
        @method grantPermissions
        @param {String} permission
        @param {User} user 
        @param {errorCallback} callback 
        @instance
        @memberof Browser
     */

    Browser.prototype.grantPermissions = function(permission, user, callback) {
      var bserver, id, mountPoint, permissionManager, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      mountPoint = bserver.mountPoint, id = bserver.id;
      permissionManager = bserver.server.permissionManager;
      return Async.waterfall([
        function(next) {
          if (!bserver.isOwner(userCtx)) {
            return next(cloudbrowserError("PERM_DENIED"));
          } else {
            return permissionManager.addBrowserPermRec({
              user: user,
              mountPoint: mountPoint,
              browserID: id,
              permission: permission,
              callback: next
            });
          }
        }
      ], function(err, browserRec) {
        if (err) {
          return callback(err);
        }
        switch (permission) {
          case 'own':
            bserver.addOwner(user);
            break;
          case 'readwrite':
            bserver.addReaderWriter(user);
            break;
          case 'readonly':
            bserver.addReader(user);
        }
        return callback(null);
      });
    };


    /**
        Renames the instance.
        @method rename
        @param {String} newName
        @fires Browser#rename
        @instance
        @memberof Browser
     */

    Browser.prototype.rename = function(newName) {
      var bserver, userCtx, _ref;
      if (typeof newName !== "string") {
        return;
      }
      _ref = _pvts[this._idx], bserver = _ref.bserver, userCtx = _ref.userCtx;
      if (bserver.isOwner(userCtx)) {
        bserver.setName(newName);
        return bserver.emit('rename', newName);
      }
    };


    /**
        Gets the application instance associated with the current browser
        @method getAppInstanceConfig
        @return {AppInstance}
        @instance
        @memberof Browser
     */

    Browser.prototype.getAppInstanceConfig = function() {
      var AppInstance, appInstance, bserver, cbCtx, userCtx, _ref;
      _ref = _pvts[this._idx], bserver = _ref.bserver, cbCtx = _ref.cbCtx, userCtx = _ref.userCtx;
      appInstance = bserver.getAppInstance();
      if (!appInstance) {
        return;
      }
      if (this.isAssocWithCurrentUser()) {
        AppInstance = require('./app_instance');
        return new AppInstance({
          cbCtx: cbCtx,
          userCtx: userCtx,
          appInstance: appInstance,
          cbServer: bserver.server
        });
      }
    };


    /**
        Gets the local state with the current browser
        @method getLocalState
        @return {Object} Custom object provided by the application in the application state file
        @instance
        @memberof Browser
     */

    Browser.prototype.getLocalState = function(property) {
      var bserver;
      bserver = _pvts[this._idx].bserver;
      if (this.isAssocWithCurrentUser()) {
        return bserver.getLocalState(property);
      }
    };


    /**
        Gets information about the users connected to the current browser
        @method getConnectedClients
        @return {Array&lt;{{address: String, email: String}}>}
        @instance
        @memberof Browser
     */

    Browser.prototype.getConnectedClients = function() {
      var bserver;
      bserver = _pvts[this._idx].bserver;
      if (this.isAssocWithCurrentUser()) {
        return bserver.getConnectedClients();
      }
    };

    return Browser;

  })();

  module.exports = Browser;

}).call(this);
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		DocStrap Copyright © 2012-2013 The contributors to the JSDoc3 and DocStrap projects.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a>
		on Sun Mar 02 2014 18:01:17 GMT-0500 (EST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
