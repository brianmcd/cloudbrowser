<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CloudBrowser Source: app_instance.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.readable.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">CloudBrowser</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="cloudbrowser.html">cloudbrowser</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.html">app</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="AppConfig.html">AppConfig</a>
						</li>
						
						<li>
							<a href="AppInstance.html">AppInstance</a>
						</li>
						
						<li>
							<a href="Browser.html">Browser</a>
						</li>
						
						<li>
							<a href="GoogleStrategy.html">GoogleStrategy</a>
						</li>
						
						<li>
							<a href="LocalStrategy.html">LocalStrategy</a>
						</li>
						
						<li>
							<a href="ServerConfig.html">ServerConfig</a>
						</li>
						
						<li>
							<a href="Util.html">Util</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="AppConfig.html#event:addAppInstance">addAppInstance</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:addBrowser">addBrowser</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:addUser">addUser</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:removeBrowser">removeBrowser</a>
						</li>
						
						<li>
							<a href="AppConfig.html#event:removeUser">removeUser</a>
						</li>
						
						<li>
							<a href="AppInstance.html#event:rename">rename</a>
						</li>
						
						<li>
							<a href="AppInstance.html#event:share">share</a>
						</li>
						
						<li>
							<a href="Browser.html#event:rename">rename</a>
						</li>
						
						<li>
							<a href="Browser.html#event:share">share</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: app_instance.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">// Generated by CoffeeScript 1.7.1
(function() {
  var AppInstance, Async, Browser, User, cloudbrowserError;

  Async = require('async');

  Browser = require('./browser');

  User = require('../server/user');

  cloudbrowserError = require('../shared/cloudbrowser_error');


  /**
      The application instance has been shared with another user
      @event AppInstance#share
   */


  /**
      The current application instance has been renamed
      @event AppInstance#rename
      @type {String}
   */


  /**
      API for application instance (internal class).
      @class AppInstance
      @param {Object}         options 
      @param {User}           options.userCtx     The current user.
      @param {AppInstance}    options.appInstance The application instance.
      @param {Cloudbrowser}   options.cbCtx       The cloudbrowser API object.
      @fires AppInstance#share
      @fires AppInstance#rename
   */

  AppInstance = (function() {
    var _pvts;

    _pvts = [];

    function AppInstance(options) {
      var appInstance, cbCtx, cbServer, userCtx;
      Object.defineProperty(this, "_idx", {
        value: _pvts.length
      });
      cbServer = options.cbServer, appInstance = options.appInstance, cbCtx = options.cbCtx, userCtx = options.userCtx;
      _pvts.push({
        cbServer: cbServer,
        cbCtx: cbCtx,
        userCtx: userCtx,
        appInstance: appInstance
      });
      Object.freeze(this.__proto__);
      Object.freeze(this);
    }


    /**
        Gets the ID of the application state.
        @method getID
        @return {Number}
        @instance
        @memberOf AppInstance
     */

    AppInstance.prototype.getID = function() {
      return _pvts[this._idx].appInstance.getID();
    };


    /**
        Gets the name of the application state.
        @method getName
        @return {String}
        @instance
        @memberOf AppInstance
     */

    AppInstance.prototype.getName = function() {
      var appInstance, name, prefix;
      appInstance = _pvts[this._idx].appInstance;
      name = appInstance.getName();
      prefix = appInstance.app.getAppInstanceName();
      return "" + prefix + " " + (name + 1);
    };


    /**
        Creates a browser associated with the current application instance.
        @method createBrowser
        @param {browserCallback} callback
        @instance
        @memberOf AppInstance
     */

    AppInstance.prototype.createBrowser = function(callback) {
      var appInstance, cbCtx, userCtx, _ref;
      _ref = _pvts[this._idx], userCtx = _ref.userCtx, cbCtx = _ref.cbCtx, appInstance = _ref.appInstance;
      return Async.waterfall([
        function(next) {
          return appInstance.createBrowser(userCtx, next);
        }, function(bserver, next) {
          return next(null, new Browser({
            browser: bserver,
            userCtx: userCtx,
            cbCtx: cbCtx
          }));
        }
      ], callback);
    };


    /**
        Gets the date of creation of the application instance.
        @method getDateCreated
        @return {Date}
        @instance
        @memberOf AppInstance
     */

    AppInstance.prototype.getDateCreated = function() {
      return _pvts[this._idx].appInstance.getDateCreated();
    };


    /**
        Closes the appInstance.
        @method close
        @param {errorCallback} callback
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.close = function(callback) {
      var appInstance, appInstances, cbServer, id, permissionManager, userCtx, _ref;
      _ref = _pvts[this._idx], cbServer = _ref.cbServer, appInstance = _ref.appInstance, userCtx = _ref.userCtx;
      appInstances = appInstance.app.appInstances;
      permissionManager = cbServer.permissionManager;
      id = appInstance.getID();
      return appInstances.remove(id, userCtx, callback);
    };


    /**
        Gets the owner of the application instance.
        @method getOwner
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.getOwner = function() {
      var appInstance, cbCtx, _ref;
      _ref = _pvts[this._idx], appInstance = _ref.appInstance, cbCtx = _ref.cbCtx;
      return appInstance.getOwner().getEmail();
    };


    /**
        Registers a listener for an event on the appInstance.
        @method addEventListener
        @param {String} event
        @param {appInstanceEventCallback} callback 
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.addEventListener = function(event, callback) {
      var appInstance, userCtx, validEvents, _ref;
      if (typeof callback !== "function") {
        return;
      }
      validEvents = ["rename", "share"];
      if (typeof event !== "string" || validEvents.indexOf(event) === -1) {
        return;
      }
      _ref = _pvts[this._idx], appInstance = _ref.appInstance, userCtx = _ref.userCtx;
      if (this.isAssocWithCurrentUser()) {
        switch (event) {
          case "rename":
            return appInstance.on(event, callback);
          case "share":
            return appInstance.on(event, function(user) {
              return callback(user.getEmail());
            });
        }
      }
    };


    /**
        Checks if the current user has some permissions associated with the 
        current appInstance (readwrite, own)
        @method isAssocWithCurrentUser
        @return {Bool}
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.isAssocWithCurrentUser = function() {
      var appInstance, userCtx, _ref;
      _ref = _pvts[this._idx], appInstance = _ref.appInstance, userCtx = _ref.userCtx;
      if (appInstance.isOwner(userCtx) || appInstance.isReaderWriter(userCtx)) {
        return true;
      } else {
        return false;
      }
    };


    /**
        Gets all users that have the permission to read and
        write to the application instance.
        @method getReaderWriters
        @return {Bool}
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.getReaderWriters = function() {
      var appInstance, rw, users, _i, _len, _ref;
      appInstance = _pvts[this._idx].appInstance;
      if (this.isAssocWithCurrentUser()) {
        users = [];
        _ref = appInstance.getReaderWriters();
        for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
          rw = _ref[_i];
          users.push(rw.getEmail());
        }
        return users;
      }
    };


    /**
        Checks if the user is a reader-writer of the instance.
        @method isReaderWriter
        @param {String} emailID
        @return {Bool} 
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.isReaderWriter = function(emailID) {
      var appInstance;
      appInstance = _pvts[this._idx].appInstance;
      if (typeof emailID !== "string") {
        return;
      }
      if (this.isAssocWithCurrentUser()) {
        if (appInstance.isReaderWriter(new User(emailID))) {
          return true;
        } else {
          return false;
        }
      }
    };


    /**
        Checks if the user is the owner of the application instance
        @method isOwner
        @param {String} user
        @return {Bool} 
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.isOwner = function(user) {
      var appInstance;
      appInstance = _pvts[this._idx].appInstance;
      if (typeof user !== "string") {
        return;
      }
      if (this.isAssocWithCurrentUser()) {
        if (appInstance.isOwner(new User(user))) {
          return true;
        } else {
          return false;
        }
      }
    };


    /**
        Grants the user readwrite permissions on the application instance.
        @method addReaderWriter
        @param {String} emailID 
        @param {errorCallback} callback 
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.addReaderWriter = function(emailID, callback) {
      var appInstance, cbServer, permissionManager, user, userCtx, _ref;
      _ref = _pvts[this._idx], cbServer = _ref.cbServer, appInstance = _ref.appInstance, userCtx = _ref.userCtx;
      permissionManager = cbServer.permissionManager;
      if (typeof emailID !== "string") {
        return typeof callback === "function" ? callback(cloudbrowserError("PARAM_INVALID", "- emailID")) : void 0;
      }
      user = new User(emailID);
      return Async.waterfall([
        function(next) {
          if (!appInstance.isOwner(userCtx)) {
            return next(cloudbrowserError("PERM_DENIED"));
          } else if (appInstance.isOwner(user)) {
            return next(cloudbrowserError("IS_OWNER"));
          } else {
            return permissionManager.addAppInstancePermRec({
              user: user,
              mountPoint: appInstance.app.getMountPoint(),
              permission: 'readwrite',
              callback: function(err) {
                return next(err);
              },
              appInstanceID: appInstance.getID()
            });
          }
        }
      ], function(err, next) {
        if (!err) {
          appInstance.addReaderWriter(user);
        }
        return callback(err);
      });
    };


    /**
        Renames the application instance.
        @method rename
        @param {String} newName
        @fires AppInstance#rename
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.rename = function(newName) {
      var appInstance, userCtx, _ref;
      _ref = _pvts[this._idx], appInstance = _ref.appInstance, userCtx = _ref.userCtx;
      if (typeof newName !== "string" || !appInstance.isOwner(userCtx)) {
        return;
      }
      appInstance.setName(newName);
      return appInstance.emit('rename', newName);
    };


    /**
        Get the application instance JavaScript object that can be used
        by the application and that is serialized and stored in the database
        @method getObj
        @return {Object} Custom object, the details of which are known only
        to the application code itself
        @instance
        @memberof AppInstance
     */

    AppInstance.prototype.getObj = function() {
      var appInstance, userCtx, _ref;
      _ref = _pvts[this._idx], appInstance = _ref.appInstance, userCtx = _ref.userCtx;
      return appInstance.getObj();
    };


    /**
        Gets the url of the application instance.
        @method getURL
        @return {String}
        @instance
        @memberOf AppInstance
     */

    AppInstance.prototype.getURL = function() {
      var appConfig, appURL, currentBrowser;
      currentBrowser = _pvts[this._idx].cbCtx.currentBrowser;
      appConfig = currentBrowser.getAppConfig();
      appURL = appConfig.getUrl();
      return "" + appURL + "/application_instance/" + (this.getID());
    };

    return AppInstance;

  })();

  module.exports = AppInstance;

}).call(this);
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		DocStrap Copyright © 2012-2013 The contributors to the JSDoc3 and DocStrap projects.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a>
		on Sun Mar 02 2014 18:01:17 GMT-0500 (EST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
